name: Central Template Sync

on:
  push:
    branches: [main]
    paths:
      - 'templates/github/**'

jobs:
  distribute:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Central Repo
        uses: actions/checkout@v4

      - name: Sync Templates to Service Repos
        uses: actions/github-script@v7
        env:
          
          SYNC_TOKEN: ${{ secrets.CENTRAL_SYNC_TOKEN }}
        with:
          github-token: ${{ env.SYNC_TOKEN }}
          script: |
            const fs = require('fs');
           
            const targetRepos = ['api-server-test']; 
            
            const issueTemplate = fs.readFileSync('templates/github/ISSUE_TEMPLATE/issue-form.yml', 'utf8');
            const prTemplate = fs.readFileSync('templates/github/pull_request_template.md', 'utf8');

            for (const repoName of targetRepos) {
              const [owner, repo] = [context.repo.owner, repoName];
              
              
              await github.rest.repos.createOrUpdateFileContents({
                owner, repo,
                path: '.github/ISSUE_TEMPLATE/bug-or-feature.yml',
                message: 'chore: sync issue template from infra',
                content: Buffer.from(issueTemplate).toString('base64'),
                sha: await getSha(owner, repo, '.github/ISSUE_TEMPLATE/issue_form.yml')
              });

              
              await github.rest.repos.createOrUpdateFileContents({
                owner, repo,
                path: '.github/pull_request_template.md',
                message: 'chore: sync PR template from infra',
                content: Buffer.from(prTemplate).toString('base64'),
                sha: await getSha(owner, repo, '.github/pull_request_template.md')
              });
            }

            async function getSha(owner, repo, path) {
              try {
                const res = await github.rest.repos.getContent({ owner, repo, path });
                return res.data.sha;
              } catch (e) { return undefined; }
            }

name: jira-sync-from-gh-issue

on:
  workflow_call:
    inputs:
      jira_project_key:
        type: string
        required: true

      issue_type_map_json:
        type: string
        required: false
        default: |
          {
            "âœ¨ feat": "Story",
            "ðŸ› fix": "Bug",
            "ðŸš‘ hotfix": "Bug",
            "ðŸ§ª spike": "Task",
            "âœ… test": "Task",
            "â™»ï¸ refactor": "Task",
            "ðŸŽ¨ style": "Task",
            "ðŸ“• docs": "Task",
            "ðŸ§¹ chore": "Task",
            "ðŸ”§ config": "Task",
            "ðŸ“¦ deps": "Task",
            "ðŸ—ï¸ build": "Task",
            "ðŸš€ deploy": "Task",
            "ðŸ·ï¸ release": "Task",
            "ðŸ›¡ï¸ security": "Task",
            "âš¡ perf": "Task",
            "ðŸ”„ rename": "Task",
            "ðŸ—‘ï¸ remove": "Task",
            "ðŸ”– init": "Task"
          }

      priority_map_json:
        type: string
        required: false
        default: |
          {
            "ðŸ”¥ priority: P0": "Highest",
            "âš ï¸ priority: P1": "High",
            "ðŸ“ priority: P2": "Medium",
            "ðŸ§Š priority: P3": "Low"
          }

      component_map_json:
        type: string
        required: false
        default: |
          {
            "ðŸ—‚ï¸ area: BE": "BE",
            "ðŸ–¥ï¸ area: FE": "FE",
            "ðŸ—„ï¸ area: DB": "DB",
            "â˜ï¸ area: INFRA": "INFRA",
            "ðŸ” area: AUTH": "AUTH"
          }

      github_linked_label:
        type: string
        required: false
        default: "ðŸ”— jira-linked"

      close_on_missing_required_labels:
        type: boolean
        required: false
        default: true

    secrets:
      JIRA_BASE_URL:
        required: true
      JIRA_EMAIL:
        required: true
      JIRA_API_TOKEN:
        required: true

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read

    steps:
      - name: Guard - skip if already has Jira key in title or jira-linked label
        id: guard
        uses: actions/github-script@v7
        env:
          LINKED_LABEL: ${{ inputs.github_linked_label }}
        with:
          script: |
            const issue = context.payload.issue;
            const title = issue.title || "";
            const labels = (issue.labels || []).map(l => (typeof l === "string" ? l : l.name));
            const hasKey = /\[[A-Z][A-Z0-9_]+-\d+\]/.test(title);
            const hasLinkedLabel = labels.includes(process.env.LINKED_LABEL);
            core.setOutput("skip", (hasKey || hasLinkedLabel) ? "true" : "false");

      # âœ… (ì¤‘ìš”) labels.*.name ê°™ì€ ë°°ì—´ í‘œí˜„ì‹ ê¸ˆì§€
      # -> ì—¬ê¸°ì„œ ë¬¸ìžì—´ 3ê°œ(type/area/priority)ë¡œ ë½‘ì•„ì„œ outputsë¡œ ì „ë‹¬
      - name: Extract type/area/priority labels
        id: pick
        if: steps.guard.outputs.skip != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const labels = (context.payload.issue.labels || [])
              .map(l => typeof l === "string" ? l : l.name);

            const TYPE = ["âœ¨ feat","ðŸ› fix","â™»ï¸ refactor","ðŸŽ¨ style","âœ… test","ðŸ“• docs","ðŸ§¹ chore","ðŸ”§ config","ðŸ“¦ deps","ðŸ—ï¸ build","ðŸš€ deploy","ðŸ·ï¸ release","ðŸš‘ hotfix","ðŸ›¡ï¸ security","âš¡ perf","ðŸ§ª spike","ðŸ”„ rename","ðŸ—‘ï¸ remove","ðŸ”– init"];
            const AREA = ["ðŸ—‚ï¸ area: BE","ðŸ–¥ï¸ area: FE","ðŸ—„ï¸ area: DB","â˜ï¸ area: INFRA","ðŸ” area: AUTH"];
            const PRIORITY = ["ðŸ”¥ priority: P0","âš ï¸ priority: P1","ðŸ“ priority: P2","ðŸ§Š priority: P3"];

            const type = labels.find(l => TYPE.includes(l)) || "";
            const area = labels.find(l => AREA.includes(l)) || "";
            const priority = labels.find(l => PRIORITY.includes(l)) || "";

            core.setOutput("type", type);
            core.setOutput("area", area);
            core.setOutput("priority", priority);

            const missing = [];
            if (!type) missing.push("type");
            if (!area) missing.push("area");
            if (!priority) missing.push("priority");
            core.setOutput("missing", missing.join(","));

      - name: Enforce required labels
        if: steps.guard.outputs.skip != 'true' && steps.pick.outputs.missing != ''
        uses: actions/github-script@v7
        env:
          MISSING: ${{ steps.pick.outputs.missing }}
          CLOSE_FLAG: ${{ inputs.close_on_missing_required_labels }}
        with:
          script: |
            const { MISSING, CLOSE_FLAG } = process.env;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: `í•„ìˆ˜ ë¼ë²¨ì´ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤: ${MISSING}\n\n- type, area, priority ë¼ë²¨ì„ ëª¨ë‘ ì¶”ê°€í•´ì£¼ì„¸ìš”.`
            });
            if (CLOSE_FLAG === 'true') {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.issue.number,
                state: "closed"
              });
            }

      - name: Resolve Jira Meta (FAIL if type_id == null)
        id: jira_meta
        if: steps.guard.outputs.skip != 'true' && steps.pick.outputs.missing == ''
        env:
          JIRA_EMAIL: ${{ secrets.JIRA_EMAIL }}
          JIRA_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          JIRA_BASE: ${{ secrets.JIRA_BASE_URL }}
          PROJ: ${{ inputs.jira_project_key }}

          TYPE_LABEL: ${{ steps.pick.outputs.type }}
          AREA_LABEL: ${{ steps.pick.outputs.area }}
          PRIORITY_LABEL: ${{ steps.pick.outputs.priority }}

          TYPE_MAP: ${{ inputs.issue_type_map_json }}
          PRIO_MAP: ${{ inputs.priority_map_json }}
          COMP_MAP: ${{ inputs.component_map_json }}
        run: |
          set -euo pipefail

          # 1) Project Info: IssueTypes
          curl -sS -u "$JIRA_EMAIL:$JIRA_TOKEN" \
            "$JIRA_BASE/rest/api/3/project/$PROJ" > proj.json

          TYPE_NAME=$(echo "$TYPE_MAP" | jq -r --arg k "$TYPE_LABEL" '.[$k] // "Task"')
          TYPE_ID=$(jq -r --arg n "$TYPE_NAME" '.issueTypes[] | select(.name==$n) | .id' proj.json | head -n 1)

          # âœ… ìš”êµ¬ì‚¬í•­: type_id == nullì´ë©´ ì¦‰ì‹œ ì‹¤íŒ¨
          if [ -z "${TYPE_ID:-}" ] || [ "$TYPE_ID" = "null" ]; then
            echo "âŒ Jira IssueType ID not found"
            echo "- picked type label: $TYPE_LABEL"
            echo "- mapped issue type name: $TYPE_NAME"
            echo "- available issue types:"
            jq -r '.issueTypes[].name' proj.json
            exit 1
          fi

          # 2) Priority ID
          curl -sS -u "$JIRA_EMAIL:$JIRA_TOKEN" \
            "$JIRA_BASE/rest/api/3/priority" > priorities.json

          PRIO_NAME=$(echo "$PRIO_MAP" | jq -r --arg k "$PRIORITY_LABEL" '.[$k] // empty')
          PRIO_ID=$(jq -r --arg n "$PRIO_NAME" '.[] | select(.name==$n) | .id' priorities.json | head -n 1)

          if [ -z "${PRIO_ID:-}" ] || [ "$PRIO_ID" = "null" ]; then
            echo "âŒ Jira Priority ID not found"
            echo "- picked priority label: $PRIORITY_LABEL"
            echo "- mapped priority name: $PRIO_NAME"
            echo "- available priorities:"
            jq -r '.[].name' priorities.json
            exit 1
          fi

          # 3) Component ID (optional)
          COMP_NAME=$(echo "$COMP_MAP" | jq -r --arg k "$AREA_LABEL" '.[$k] // empty')
          curl -sS -u "$JIRA_EMAIL:$JIRA_TOKEN" \
            "$JIRA_BASE/rest/api/3/project/$PROJ/components" > components.json

          COMP_ID=$(jq -r --arg n "$COMP_NAME" '.[] | select(.name==$n) | .id' components.json | head -n 1)
          if [ -z "${COMP_ID:-}" ] || [ "$COMP_ID" = "null" ]; then
            COMP_ID="null"
          fi

          echo "type_id=$TYPE_ID" >> "$GITHUB_OUTPUT"
          echo "priority_id=$PRIO_ID" >> "$GITHUB_OUTPUT"
          echo "component_id=$COMP_ID" >> "$GITHUB_OUTPUT"

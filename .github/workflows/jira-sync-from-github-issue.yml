name: jira-sync-from-gh-issue

on:
  workflow_call:
    inputs:
      jira_project_key:
        type: string
        required: true
      # Jiraì˜ 'ì‹œì‘ ë‚ ì§œ' í•„ë“œ IDëŠ” í™˜ê²½ë§ˆë‹¤ ë‹¤ë¥´ë¯€ë¡œ ë³€ìˆ˜í™” (ë³´í†µ customfield_10015)
      jira_start_date_field:
        type: string
        required: false
        default: "customfield_10015"
    secrets:
      JIRA_BASE_URL:
        required: true
      JIRA_EMAIL:
        required: true
      JIRA_API_TOKEN:
        required: true

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: write

    steps:
      # 1. ì´ìŠˆ ë³¸ë¬¸ íŒŒì‹±: ì •ê·œí‘œí˜„ì‹ì„ ì‚¬ìš©í•˜ì—¬ í…œí”Œë¦¿ì˜ ë°ì´í„°ë¥¼ ì¶”ì¶œí•©ë‹ˆë‹¤.
      - name: Parse Issue Body
        id: parse
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.issue.body || "";
            const extract = (id) => {
              const regex = new RegExp(`### ${id}\\s+([\\s\\S]*?)(?=\\n###|$)`);
              const match = body.match(regex);
              return match ? match[1].trim() : "";
            };

            const parentKey = extract('ğŸŸï¸ ìƒìœ„ ì‘ì—… \\(Ticket Number\\)');
            const startDate = extract('ğŸ“… ì‹œì‘ ë‚ ì§œ');
            const endDate = extract('ğŸ ì¢…ë£Œ ë‚ ì§œ');
            const type = extract('Type \\(í•„ìˆ˜\\)');
            const area = extract('Area \\(í•„ìˆ˜\\)');
            const priority = extract('Priority \\(í•„ìˆ˜\\)');

            core.setOutput('parentKey', parentKey);
            core.setOutput('startDate', startDate);
            core.setOutput('endDate', endDate);
            core.setOutput('type', type);
            core.setOutput('area', area);
            core.setOutput('priority', priority);

      # 2. ê¹ƒí—ˆë¸Œ ë¼ë²¨ ìë™ ë¶€ì°©: ì´ìŠˆ ìƒì„± ì‹œ ì„ íƒí•œ íƒœê·¸ë¥¼ ì‹¤ì œ GitHub ë¼ë²¨ë¡œ ë“±ë¡í•©ë‹ˆë‹¤.
      - name: Auto-Labeling GitHub Issue
        if: github.event.action == 'opened'
        uses: actions/github-script@v7
        with:
          script: |
            const { type, area, priority } = steps.parse.outputs;
            const labels = [type, area, priority].filter(l => l && l !== 'ì„ íƒí•˜ì„¸ìš”');
            if (labels.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.issue.number,
                labels: labels
              });
            }

      # 3. Jira í‹°ì¼“ ìƒì„± (ìƒìœ„ í•­ëª© & ë‚ ì§œ ë°˜ì˜)
      - name: Create Jira Issue
        id: create
        if: github.event.action == 'opened' || github.event.action == 'reopened'
        env:
          JIRA_EMAIL: ${{ secrets.JIRA_EMAIL }}
          JIRA_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          JIRA_BASE: ${{ secrets.JIRA_BASE_URL }}
          START_FIELD: ${{ inputs.jira_start_date_field }}
        run: |
          # ë§µí•‘: í…œí”Œë¦¿ì˜ ì´ëª¨ì§€ í¬í•¨ íƒ€ì…ì„ Jira íƒ€ì… ëª…ì¹­ìœ¼ë¡œ ë³€í™˜
          case "${{ steps.parse.outputs.type }}" in
            "âœ¨ feat") JIRA_TYPE="ìŠ¤í† ë¦¬" ;;
            "ğŸ› fix" | "ğŸš‘ hotfix") JIRA_TYPE="ë²„ê·¸" ;;
            *) JIRA_TYPE="ì‘ì—…" ;;
          esac

          # JSON í˜ì´ë¡œë“œ ë¹Œë“œ
          # parent: ìƒìœ„ í‹°ì¼“ ì—°ê²° / duedate: ì¢…ë£Œì¼ / customfield: ì‹œì‘ì¼
          PAYLOAD=$(jq -n \
            --arg proj "${{ inputs.jira_project_key }}" \
            --arg type "$JIRA_TYPE" \
            --arg sum "${{ github.event.issue.title }}" \
            --arg desc "GitHub: ${{ github.event.issue.html_url }}\n\n${{ github.event.issue.body }}" \
            --arg parent "${{ steps.parse.outputs.parentKey }}" \
            --arg start "${{ steps.parse.outputs.startDate }}" \
            --arg end "${{ steps.parse.outputs.endDate }}" \
            --arg sf "$START_FIELD" \
            '{
              fields: {
                project: { key: $proj },
                issuetype: { name: $type },
                summary: $sum,
                description: { type: "doc", version: 1, content: [{ type: "paragraph", content: [{ type: "text", text: $desc }] }] },
                parent: (if $parent != "" then { key: $parent } else null end),
                duedate: (if $end != "" then $end else null end),
                ($sf): (if $start != "" then $start else null end)
              }
            }' | jq 'del(.fields.parent | select(. == null))')

          RES=$(curl -s -u "$JIRA_EMAIL:$JIRA_TOKEN" -X POST -H "Content-Type: application/json" -d "$PAYLOAD" "$JIRA_BASE/rest/api/3/issue")
          echo "jira_key=$(echo $RES | jq -r '.key')" >> "$GITHUB_OUTPUT"

      # 4. Jira ìƒíƒœ ë³€ê²½: ìƒì„± ì§í›„ 'ì§„í–‰ ì¤‘'ìœ¼ë¡œ ë³€ê²½
      - name: Transition to In Progress
        if: steps.create.outputs.jira_key != ''
        env:
          JIRA_EMAIL: ${{ secrets.JIRA_EMAIL }}
          JIRA_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          JIRA_BASE: ${{ secrets.JIRA_BASE_URL }}
        run: |
          # 'ì§„í–‰ ì¤‘' íŠ¸ëœì§€ì…˜ ID (ë³´í†µ 21, í”„ë¡œì íŠ¸ ì„¤ì •ì— ë”°ë¼ í™•ì¸ í•„ìš”)
          curl -s -u "$JIRA_EMAIL:$JIRA_TOKEN" -X POST -H "Content-Type: application/json" \
            -d '{"transition": {"id": "21"}}' \
            "$JIRA_BASE/rest/api/3/issue/${{ steps.create.outputs.jira_key }}/transitions"

      # 5. ì´ìŠˆ Close ì‹œ Jira 'ì™„ë£Œ' ì²˜ë¦¬
      - name: Transition to Done
        if: github.event.action == 'closed'
        env:
          JIRA_EMAIL: ${{ secrets.JIRA_EMAIL }}
          JIRA_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          JIRA_BASE: ${{ secrets.JIRA_BASE_URL }}
        run: |
          # ì œëª©ì—ì„œ [PROJ-123] í˜•íƒœì˜ í‚¤ ì¶”ì¶œ
          KEY=$(echo "${{ github.event.issue.title }}" | grep -oE '[A-Z0-9]+-[0-9]+' | head -1)
          if [ -z "$KEY" ]; then exit 0; fi
          
          # 'ì™„ë£Œ' íŠ¸ëœì§€ì…˜ ID (ë³´í†µ 31)
          curl -s -u "$JIRA_EMAIL:$JIRA_TOKEN" -X POST -H "Content-Type: application/json" \
            -d '{"transition": {"id": "31"}}' \
            "$JIRA_BASE/rest/api/3/issue/$KEY/transitions"

      # 6. GitHub ì´ìŠˆ ì •ë³´ ì—…ë°ì´íŠ¸ (ì œëª©ì— í‚¤ ì‚½ì… ë° ì½”ë©˜íŠ¸)
      - name: Update GitHub Issue
        if: steps.create.outputs.jira_key != ''
        uses: actions/github-script@v7
        with:
          script: |
            const key = "${{ steps.create.outputs.jira_key }}";
            const currentTitle = context.payload.issue.title;
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              title: `[${key}] ${currentTitle}`
            });
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: `âœ… Jira í‹°ì¼“ ìƒì„± ë° ì—°ë™ ì™„ë£Œ: [${key}](${{ secrets.JIRA_BASE_URL }}/browse/${key})\n- ìƒíƒœ: ì§„í–‰ ì¤‘ (In Progress)\n- íƒ€ì„ë¼ì¸: ${{ steps.parse.outputs.startDate }} ~ ${{ steps.parse.outputs.endDate }}`
            });

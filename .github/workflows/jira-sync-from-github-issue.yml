name: jira-sync-from-gh-issue

on:
  workflow_call:
    inputs:
      jira_project_key:
        type: string
        required: true
      jira_start_date_field:
        type: string
        required: false
        default: "customfield_10015" 
      jira_sprint_field:
        type: string
        required: false
        default: "customfield_10020"
      jira_team_field:
        type: string
        required: false
        default: "customfield_10001"
    secrets:
      JIRA_BASE_URL:
        required: true
      JIRA_EMAIL:
        required: true
      JIRA_API_TOKEN:
        required: true

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: write

    steps:
      # 1. ì´ìŠˆ í…œí”Œë¦¿ í•­ëª©ë³„ ë°ì´í„° ì¶”ì¶œ
      - name: Parse Issue Body
        id: parse
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.issue.body || "";
            const extract = (id) => {
              const regex = new RegExp(`### ${id}\\s+([\\s\\S]*?)(?=\\n###|$)`);
              const match = body.match(regex);
              return match ? match[1].trim() : "";
            };
            core.setOutput('team', extract('Team \\(í•„ìˆ˜\\)'));
            core.setOutput('parentKey', extract('ğŸŸï¸ ìƒìœ„ ì‘ì—… \\(Ticket Number\\)'));
            core.setOutput('startDate', extract('ğŸ“… ì‹œì‘ ë‚ ì§œ'));
            core.setOutput('endDate', extract('ğŸ ì¢…ë£Œ ë‚ ì§œ'));
            core.setOutput('type', extract('Type \\(í•„ìˆ˜\\)'));
            core.setOutput('area', extract('Area \\(í•„ìˆ˜\\)'));
            core.setOutput('priority', extract('Priority \\(í•„ìˆ˜\\)'));

      # 2. íŒŒì‹±í•œ ë°ì´í„° ê¸°ë°˜ GH ì´ìŠˆ ë¼ë²¨ ìë™ ë¶€ì—¬
      - name: Auto-Labeling GitHub Issue
        if: github.event.action == 'opened' || github.event.action == 'reopened'
        uses: actions/github-script@v7
        env:
          ISSUE_TYPE: ${{ steps.parse.outputs.type }}
          ISSUE_AREA: ${{ steps.parse.outputs.area }}
          ISSUE_PRIO: ${{ steps.parse.outputs.priority }}
          ISSUE_TEAM: ${{ steps.parse.outputs.team }}
        with:
          script: |
            const { ISSUE_TYPE, ISSUE_AREA, ISSUE_PRIO, ISSUE_TEAM } = process.env;
            const labelsToAdd = [ISSUE_TYPE, ISSUE_AREA, ISSUE_PRIO, ISSUE_TEAM].filter(l => l && l !== 'ì„ íƒí•˜ì„¸ìš”');
            if (labelsToAdd.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner, repo: context.repo.repo,
                issue_number: context.payload.issue.number, labels: labelsToAdd
              });
            }

      # 3. ì§€ë¼ ë³´ë“œì—ì„œ í˜„ì¬ ì§„í–‰ ì¤‘ì¸ ìŠ¤í”„ë¦°íŠ¸ ID í™•ì¸
      - name: Get Active Sprint ID
        id: sprint
        env:
          JIRA_EMAIL: ${{ secrets.JIRA_EMAIL }}
          JIRA_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          JIRA_BASE: ${{ secrets.JIRA_BASE_URL }}
          PROJ: ${{ inputs.jira_project_key }}
        run: |
          # 1. í”„ë¡œì íŠ¸ì— ì—°ê²°ëœ ë³´ë“œ ID ì¡°íšŒ
          BOARD_ID=$(curl -s -u "$JIRA_EMAIL:$JIRA_TOKEN" "$JIRA_BASE/rest/agile/1.0/board?projectKeyOrId=$PROJ" | jq -r '.values[0].id')
          
          # 2. í•´ë‹¹ ë³´ë“œì—ì„œ 'í™œì„±(active)' ìƒíƒœì¸ ìŠ¤í”„ë¦°íŠ¸ ID ì¡°íšŒ
          if [ "$BOARD_ID" != "null" ]; then
            SPRINT_ID=$(curl -s -u "$JIRA_EMAIL:$JIRA_TOKEN" "$JIRA_BASE/rest/agile/1.0/board/$BOARD_ID/sprint?state=active" | jq -r '.values[0].id')
            echo "sprint_id=${SPRINT_ID:-null}" >> "$GITHUB_OUTPUT"
          else
            echo "sprint_id=null" >> "$GITHUB_OUTPUT"
          fi

      # 4. Jira í‹°ì¼“ ìƒì„± ë° í•„ë“œ ë§¤í•‘
      - name: Create Jira Issue
        id: create
        if: github.event.action == 'opened' || github.event.action == 'reopened'
        env:
          JIRA_EMAIL: ${{ secrets.JIRA_EMAIL }}
          JIRA_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          JIRA_BASE: ${{ secrets.JIRA_BASE_URL }}
          START_FIELD: ${{ inputs.jira_start_date_field }}
          SPRINT_FIELD: ${{ inputs.jira_sprint_field }}
          SPRINT_ID: ${{ steps.sprint.outputs.sprint_id }}
          TEAM_NAME: ${{ steps.parse.outputs.team }}
          TEAM_FIELD: ${{ inputs.jira_team_field }}
        run: |
          case "${{ steps.parse.outputs.type }}" in
            "âœ¨ feat") JIRA_TYPE="ìŠ¤í† ë¦¬" ;;
            "ğŸ› fix" | "ğŸš‘ hotfix") JIRA_TYPE="ë²„ê·¸" ;;
            *) JIRA_TYPE="ì‘ì—…" ;;
          esac
          case "$TEAM_NAME" in
            "Customer Team") TEAM_ID="f394bb25-56b9-41e0-b4da-7ae0c1cbbe19" ;;
            "Counselor Team") TEAM_ID="646fca13-0bcc-4061-978a-3d6c91c0dc80" ;;
            "Admin Team") TEAM_ID="31fa7d97-fd21-4428-a7b1-ce4b849a19c7" ;;
            "Infra Team") TEAM_ID="b8a5960c-ab7e-4f66-a48b-9fe9fe4d1a31" ;;
            "Auth Team") TEAM_ID="84b2225f-0e11-410b-b416-672cc2e7b3f2" ;;
            *) TEAM_ID="null" ;;
          esac
          
          PAYLOAD=$(jq -n \
            --arg proj "${{ inputs.jira_project_key }}" \
            --arg type "$JIRA_TYPE" \
            --arg sum "${{ github.event.issue.title }}" \
            --arg desc "GitHub: ${{ github.event.issue.html_url }}\n\n${{ github.event.issue.body }}" \
            --arg parent "${{ steps.parse.outputs.parentKey }}" \
            --arg start "${{ steps.parse.outputs.startDate }}" \
            --arg end "${{ steps.parse.outputs.endDate }}" \
            --arg sprint "$SPRINT_ID" \
            --arg sf "$START_FIELD" \
            --arg sp "$SPRINT_FIELD" \
            --arg tf "$TEAM_FIELD" \
            '{
              fields: {
                project: { key: $proj },
                issuetype: { name: $type },
                summary: $sum,
                description: { type: "doc", version: 1, content: [{ type: "paragraph", content: [{ type: "text", text: $desc }] }] },
                parent: (if $parent != "" then { key: $parent } else null end),
                duedate: (if $end != "" then $end else null end),
                ($sf): (if $start != "" then $start else null end),
                ($sp): (if $sprint != "null" then ($sprint | tonumber) else null end)
                ($tf): (if $team != "null" then $team else null end)
              }
            }' | jq 'del(.fields.parent | select(. == null)) | del(.fields | .[] | select(. == null))')

          RES=$(curl -s -u "$JIRA_EMAIL:$JIRA_TOKEN" -X POST -H "Content-Type: application/json" -d "$PAYLOAD" "$JIRA_BASE/rest/api/3/issue")
          echo "jira_key=$(echo $RES | jq -r '.key')" >> "$GITHUB_OUTPUT"

      # 5. í‹°ì¼“ ìƒì„± ì§í›„ 'ì§„í–‰ ì¤‘' ìƒíƒœ ë³€ê²½
      - name: Transition to In Progress
        if: steps.create.outputs.jira_key != ''
        env:
          JIRA_EMAIL: ${{ secrets.JIRA_EMAIL }}
          JIRA_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          JIRA_BASE: ${{ secrets.JIRA_BASE_URL }}
        run: |
          curl -s -u "$JIRA_EMAIL:$JIRA_TOKEN" -X POST -H "Content-Type: application/json" \
            -d '{"transition": {"id": "21"}}' \
            "$JIRA_BASE/rest/api/3/issue/${{ steps.create.outputs.jira_key }}/transitions"
      
      # 6. Jira í‚¤ í¬í•¨ëœ ì‘ì—…ìš© ë¸Œëœì¹˜ ìƒì„±
      - name: Create Automatic Branch
        id: create_branch
        if: steps.create.outputs.jira_key != ''
        uses: actions/github-script@v7
        env:
          JIRA_KEY: ${{ steps.create.outputs.jira_key }}
          TYPE_LABEL: ${{ steps.parse.outputs.type }}
        with:
          script: |
            const { JIRA_KEY, TYPE_LABEL } = process.env;
           
            const typeMap = {
              "âœ¨ feat": "feat", "ğŸ› fix": "fix", "ğŸš‘ hotfix": "hotfix",
              "â™»ï¸ refactor": "refactor", "ğŸ¨ style": "style", "âœ… test": "test",
              "ğŸ“• docs": "docs", "ğŸ§¹ chore": "chore", "ğŸ”§ config": "config",
              "ğŸ“¦ deps": "deps", "ğŸ—ï¸ build": "build", "ğŸš€ deploy": "deploy",
              "âš¡ perf": "perf", "ğŸ§ª spike": "spike"
            };
            
            const prefix = typeMap[TYPE_LABEL] || "task";
            const branchName = `${prefix}/${JIRA_KEY}`;
            
            try {
              const repo = await github.rest.repos.get({ owner: context.repo.owner, repo: context.repo.repo });
              const defaultBranch = await github.rest.repos.getBranch({
                owner: context.repo.owner,
                repo: context.repo.repo,
                branch: repo.data.default_branch
              });
            
              await github.rest.git.createRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: `refs/heads/${branchName}`,
                sha: defaultBranch.data.commit.sha
              });
              
              core.info(`Branch created: ${branchName}`);
              core.setOutput('branch_name', branchName);
            } catch (error) {
              core.warning(`Branch creation failed or already exists: ${error.message}`);
              core.setOutput('branch_name', branchName);
            }

      # 7. ì´ìŠˆ í´ë¡œì¦ˆ ì‹œ ì§€ë¼ í‹°ì¼“ ìë™ ì™„ë£Œ ì²˜ë¦¬
      - name: Transition to Done
        if: github.event.action == 'closed'
        env:
          JIRA_EMAIL: ${{ secrets.JIRA_EMAIL }}
          JIRA_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          JIRA_BASE: ${{ secrets.JIRA_BASE_URL }}
        run: |
          KEY=$(echo "${{ github.event.issue.title }}" | grep -oE '[A-Z0-9]+-[0-9]+' | head -1)
          if [ -n "$KEY" ]; then
            curl -s -u "$JIRA_EMAIL:$JIRA_TOKEN" -X POST -H "Content-Type: application/json" \
              -d '{"transition": {"id": "31"}}' \
              "$JIRA_BASE/rest/api/3/issue/$KEY/transitions"
          fi

      # 8. GH ì´ìŠˆ ì œëª©ì— Jira í‚¤ ì¶”ê°€ ë° ì½”ë©˜íŠ¸ ì‘ì„±
      - name: Finalize GitHub Issue
        if: steps.create.outputs.jira_key != ''
        uses: actions/github-script@v7
        env:
          JIRA_KEY: ${{ steps.create.outputs.jira_key }}
          JIRA_BASE: ${{ secrets.JIRA_BASE_URL }}
          BRANCH_NAME: ${{ steps.create_branch.outputs.branch_name }}
        with:
          script: |
            const { JIRA_KEY, JIRA_BASE, BRANCH_NAME } = process.env;
            const issue = context.payload.issue;
            const cleanTitle = issue.title.replace(/^\[[A-Z0-9-]+\]\s+/, "").trim();
            await github.rest.issues.update({
              owner: context.repo.owner, repo: context.repo.repo,
              issue_number: issue.number, title: `[${JIRA_KEY}] ${cleanTitle}`
            });
            await github.rest.issues.createComment({
              owner: context.repo.owner, repo: context.repo.repo, issue_number: issue.number,
              body: `### âœ… Jira ì—°ë™ ë° ê°œë°œ ì¤€ë¹„ ì™„ë£Œ\n- **í‹°ì¼“:** [${JIRA_KEY}](${JIRA_BASE}/browse/${JIRA_KEY})\n- **ìƒì„±ëœ ë¸Œëœì¹˜:** \`${BRANCH_NAME}\`\n- **ìƒíƒœ:** ì§„í–‰ ì¤‘(In Progress) ë° í˜„ì¬ ìŠ¤í”„ë¦°íŠ¸ í• ë‹¹ ì™„ë£Œ`
            });

name: jira-sync-from-gh-issue

on:
  workflow_call:
    inputs:
      jira_project_key:
        type: string
        required: true

      issue_type_map_json:
        type: string
        required: false
        default: |
          {
            "‚ú® feat": "Story",
            "üêõ fix": "Bug",
            "üöë hotfix": "Bug",
            "üß™ spike": "Task",
            "‚úÖ test": "Task",
            "‚ôªÔ∏è refactor": "Task",
            "üé® style": "Task",
            "üìï docs": "Task",
            "üßπ chore": "Task",
            "üîß config": "Task",
            "üì¶ deps": "Task",
            "üèóÔ∏è build": "Task",
            "üöÄ deploy": "Task",
            "üè∑Ô∏è release": "Task",
            "üõ°Ô∏è security": "Task",
            "‚ö° perf": "Task",
            "üîÑ rename": "Task",
            "üóëÔ∏è remove": "Task",
            "üîñ init": "Task"
          }

      priority_map_json:
        type: string
        required: false
        default: |
          {
            "üî• priority: P0": "Highest",
            "‚ö†Ô∏è priority: P1": "High",
            "üìù priority: P2": "Medium",
            "üßä priority: P3": "Low"
          }

      component_map_json:
        type: string
        required: false
        default: |
          {
            "üóÇÔ∏è area: BE": "BE",
            "üñ•Ô∏è area: FE": "FE",
            "üóÑÔ∏è area: DB": "DB",
            "‚òÅÔ∏è area: INFRA": "INFRA",
            "üîê area: AUTH": "AUTH"
          }

      github_linked_label:
        type: string
        required: false
        default: "üîó jira-linked"

      close_on_missing_required_labels:
        type: boolean
        required: false
        default: true

    secrets:
      JIRA_BASE_URL:
        required: true
      JIRA_EMAIL:
        required: true
      JIRA_API_TOKEN:
        required: true

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read

    steps:
      - name: Resolve Jira Meta
        id: jira_meta
        env:
          JIRA_EMAIL: ${{ secrets.JIRA_EMAIL }}
          JIRA_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          JIRA_BASE: ${{ secrets.JIRA_BASE_URL }}
          PROJ: ${{ inputs.jira_project_key }}
          TYPE_LABEL: ${{ github.event.issue.labels.*.name }}
          TYPE_MAP: ${{ inputs.issue_type_map_json }}
        run: |
          curl -sS -u "$JIRA_EMAIL:$JIRA_TOKEN" \
            "$JIRA_BASE/rest/api/3/project/$PROJ" > proj.json

          TYPE_NAME=$(echo "$TYPE_MAP" | jq -r --arg k "‚úÖ test" '.[$k] // empty')
          TYPE_ID=$(jq -r --arg n "$TYPE_NAME" '.issueTypes[] | select(.name==$n) | .id' proj.json)

          if [ -z "$TYPE_ID" ] || [ "$TYPE_ID" = "null" ]; then
            echo "‚ùå Jira IssueType ID not found"
            jq -r '.issueTypes[].name' proj.json
            exit 1
          fi

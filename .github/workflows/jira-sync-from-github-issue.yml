name: jira-sync-from-gh-issue

on:
  workflow_call:
    inputs:
      jira_project_key:
        type: string
        required: true

      issue_type_map_json:
        type: string
        required: false
        default: |
          {
            "‚ú® feat": "Ïä§ÌÜ†Î¶¨",
            "üêõ fix": "Î≤ÑÍ∑∏",
            "üöë hotfix": "Î≤ÑÍ∑∏",

            "üß™ spike": "ÏûëÏóÖ",
            "‚úÖ test": "ÏûëÏóÖ",
            "‚ôªÔ∏è refactor": "ÏûëÏóÖ",
            "üé® style": "ÏûëÏóÖ",
            "üìï docs": "ÏûëÏóÖ",
            "üßπ chore": "ÏûëÏóÖ",
            "üîß config": "ÏûëÏóÖ",
            "üì¶ deps": "ÏûëÏóÖ",
            "üèóÔ∏è build": "ÏûëÏóÖ",
            "üöÄ deploy": "ÏûëÏóÖ",
            "üè∑Ô∏è release": "ÏûëÏóÖ",
            "üõ°Ô∏è security": "ÏûëÏóÖ",
            "‚ö° perf": "ÏûëÏóÖ",
            "üîÑ rename": "ÏûëÏóÖ",
            "üóëÔ∏è remove": "ÏûëÏóÖ",
            "üîñ init": "ÏûëÏóÖ"
          }

      priority_map_json:
        type: string
        required: false
        default: |
          {
            "üî• priority: P0": "Highest",
            "‚ö†Ô∏è priority: P1": "High",
            "üìù priority: P2": "Medium",
            "üßä priority: P3": "Low"
          }

      component_map_json:
        type: string
        required: false
        default: |
          {
            "üóÇÔ∏è area: BE": "BE",
            "üñ•Ô∏è area: FE": "FE",
            "üóÑÔ∏è area: DB": "DB",
            "‚òÅÔ∏è area: INFRA": "INFRA",
            "üîê area: AUTH": "AUTH"
          }

      github_linked_label:
        type: string
        required: false
        default: "üîó jira-linked"

      close_on_missing_required_labels:
        type: boolean
        required: false
        default: true

    secrets:
      JIRA_BASE_URL:
        required: true
      JIRA_EMAIL:
        required: true
      JIRA_API_TOKEN:
        required: true

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read

    steps:
      - name: Guard - skip if already has Jira key in title or jira-linked label
        id: guard
        uses: actions/github-script@v7
        env:
          LINKED_LABEL: ${{ inputs.github_linked_label }}
        with:
          script: |
            const issue = context.payload.issue;
            const title = issue.title || "";
            const labels = (issue.labels || []).map(l => (typeof l === "string" ? l : l.name));
            const hasKey = /\[[A-Z][A-Z0-9_]+-\d+\]/.test(title);
            const hasLinkedLabel = labels.includes(process.env.LINKED_LABEL);
            core.setOutput("skip", (hasKey || hasLinkedLabel) ? "true" : "false");

      - name: Extract type/area/priority labels
        id: pick
        if: steps.guard.outputs.skip != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const labels = (context.payload.issue.labels || [])
              .map(l => typeof l === "string" ? l : l.name);

            const TYPE = [
              "‚ú® feat","üêõ fix","‚ôªÔ∏è refactor","üé® style","‚úÖ test","üìï docs","üßπ chore","üîß config","üì¶ deps",
              "üèóÔ∏è build","üöÄ deploy","üè∑Ô∏è release","üöë hotfix","üõ°Ô∏è security","‚ö° perf","üß™ spike",
              "üîÑ rename","üóëÔ∏è remove","üîñ init"
            ];
            const AREA = ["üóÇÔ∏è area: BE","üñ•Ô∏è area: FE","üóÑÔ∏è area: DB","‚òÅÔ∏è area: INFRA","üîê area: AUTH"];
            const PRIORITY = ["üî• priority: P0","‚ö†Ô∏è priority: P1","üìù priority: P2","üßä priority: P3"];

            const type = labels.find(l => TYPE.includes(l)) || "";
            const area = labels.find(l => AREA.includes(l)) || "";
            const priority = labels.find(l => PRIORITY.includes(l)) || "";

            core.setOutput("type", type);
            core.setOutput("area", area);
            core.setOutput("priority", priority);

            const missing = [];
            if (!type) missing.push("type");
            if (!area) missing.push("area");
            if (!priority) missing.push("priority");
            core.setOutput("missing", missing.join(","));

      - name: Enforce required labels
        if: steps.guard.outputs.skip != 'true' && steps.pick.outputs.missing != ''
        uses: actions/github-script@v7
        env:
          MISSING: ${{ steps.pick.outputs.missing }}
          CLOSE_FLAG: ${{ inputs.close_on_missing_required_labels }}
        with:
          script: |
            const { MISSING, CLOSE_FLAG } = process.env;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: `ÌïÑÏàò ÎùºÎ≤®Ïù¥ ÎàÑÎùΩÎêòÏóàÏäµÎãàÎã§: ${MISSING}\n\n- type, area, priority ÎùºÎ≤®ÏùÑ Î™®Îëê Ï∂îÍ∞ÄÌï¥Ï£ºÏÑ∏Ïöî.`
            });
            if (CLOSE_FLAG === 'true') {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.issue.number,
                state: "closed"
              });
            }

      - name: Resolve Jira Meta (FAIL if type_id == null)
        id: jira_meta
        if: steps.guard.outputs.skip != 'true' && steps.pick.outputs.missing == ''
        env:
          JIRA_EMAIL: ${{ secrets.JIRA_EMAIL }}
          JIRA_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          JIRA_BASE: ${{ secrets.JIRA_BASE_URL }}
          PROJ: ${{ inputs.jira_project_key }}

          TYPE_LABEL: ${{ steps.pick.outputs.type }}
          AREA_LABEL: ${{ steps.pick.outputs.area }}
          PRIORITY_LABEL: ${{ steps.pick.outputs.priority }}

          TYPE_MAP: ${{ inputs.issue_type_map_json }}
          PRIO_MAP: ${{ inputs.priority_map_json }}
          COMP_MAP: ${{ inputs.component_map_json }}
        run: |
          set -euo pipefail

          # 1) Project Info: IssueTypes
          curl -sS -u "$JIRA_EMAIL:$JIRA_TOKEN" \
            "$JIRA_BASE/rest/api/3/project/$PROJ" > proj.json

          TYPE_NAME=$(echo "$TYPE_MAP" | jq -r --arg k "$TYPE_LABEL" '.[$k] // "ÏûëÏóÖ"')
          TYPE_ID=$(jq -r --arg n "$TYPE_NAME" '.issueTypes[] | select(.name==$n) | .id' proj.json | head -n 1)

          echo "TYPE_LABEL=$TYPE_LABEL"
          echo "TYPE_NAME=$TYPE_NAME"

          if [ -z "${TYPE_ID:-}" ] || [ "$TYPE_ID" = "null" ]; then
            echo "‚ùå Jira IssueType ID not found"
            echo "- picked type label: $TYPE_LABEL"
            echo "- mapped issue type name: $TYPE_NAME"
            echo "- available issue types:"
            jq -r '.issueTypes[].name' proj.json
            exit 1
          fi

          # 2) Priority ID
          curl -sS -u "$JIRA_EMAIL:$JIRA_TOKEN" \
            "$JIRA_BASE/rest/api/3/priority" > priorities.json

          PRIO_NAME=$(echo "$PRIO_MAP" | jq -r --arg k "$PRIORITY_LABEL" '.[$k] // empty')
          PRIO_ID=$(jq -r --arg n "$PRIO_NAME" '.[] | select(.name==$n) | .id' priorities.json | head -n 1)

          if [ -z "${PRIO_ID:-}" ] || [ "$PRIO_ID" = "null" ]; then
            echo "‚ùå Jira Priority ID not found"
            echo "- picked priority label: $PRIORITY_LABEL"
            echo "- mapped priority name: $PRIO_NAME"
            echo "- available priorities:"
            jq -r '.[].name' priorities.json
            exit 1
          fi

          # 3) Component ID (optional)
          COMP_NAME=$(echo "$COMP_MAP" | jq -r --arg k "$AREA_LABEL" '.[$k] // empty')
          curl -sS -u "$JIRA_EMAIL:$JIRA_TOKEN" \
            "$JIRA_BASE/rest/api/3/project/$PROJ/components" > components.json

          COMP_ID=$(jq -r --arg n "$COMP_NAME" '.[] | select(.name==$n) | .id' components.json | head -n 1)
          if [ -z "${COMP_ID:-}" ] || [ "$COMP_ID" = "null" ]; then
            COMP_ID="null"
          fi

          echo "type_id=$TYPE_ID" >> "$GITHUB_OUTPUT"
          echo "priority_id=$PRIO_ID" >> "$GITHUB_OUTPUT"
          echo "component_id=$COMP_ID" >> "$GITHUB_OUTPUT"

      - name: Create Jira issue
        id: create
        if: steps.guard.outputs.skip != 'true' && steps.pick.outputs.missing == ''
        env:
          JIRA_EMAIL: ${{ secrets.JIRA_EMAIL }}
          JIRA_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          JIRA_BASE: ${{ secrets.JIRA_BASE_URL }}
          PROJ: ${{ inputs.jira_project_key }}

          GH_TITLE: ${{ github.event.issue.title }}
          GH_BODY: ${{ github.event.issue.body }}
          GH_URL: ${{ github.event.issue.html_url }}

          TYPE_ID: ${{ steps.jira_meta.outputs.type_id }}
          PRIO_ID: ${{ steps.jira_meta.outputs.priority_id }}
          COMP_ID: ${{ steps.jira_meta.outputs.component_id }}
        run: |
          set -euo pipefail

          DESC="GitHub Issue: $GH_URL\n\n$GH_BODY"

          jq -n \
            --arg proj "$PROJ" \
            --arg tid "$TYPE_ID" \
            --arg pid "$PRIO_ID" \
            --arg sum "$GH_TITLE" \
            --arg desc "$DESC" \
            '{
              fields: {
                project: { key: $proj },
                issuetype: { id: $tid },
                priority: { id: $pid },
                summary: $sum,
                description: {
                  type: "doc",
                  version: 1,
                  content: [{
                    type: "paragraph",
                    content: [{ type: "text", text: $desc }]
                  }]
                }
              }
            }' > payload.json

          if [ "$COMP_ID" != "null" ] && [ -n "$COMP_ID" ]; then
            jq '.fields.components = [{id: $id}]' --arg id "$COMP_ID" payload.json > tmp.json && mv tmp.json payload.json
          fi

          http=$(curl -sS -u "$JIRA_EMAIL:$JIRA_TOKEN" \
            -o res.json -w "%{http_code}" \
            -X POST -H "Content-Type: application/json" \
            -d @payload.json "$JIRA_BASE/rest/api/3/issue")

          if [ "$http" -lt 200 ] || [ "$http" -ge 300 ]; then
            echo "‚ùå Jira create failed. HTTP=$http"
            cat res.json | jq .
            exit 1
          fi

          JIRA_KEY=$(jq -r '.key' res.json)
          if [ -z "$JIRA_KEY" ] || [ "$JIRA_KEY" = "null" ]; then
            echo "‚ùå Jira create returned no key"
            cat res.json | jq .
            exit 1
          fi

          echo "jira_key=$JIRA_KEY" >> "$GITHUB_OUTPUT"

      - name: Update GitHub Issue
        if: steps.guard.outputs.skip != 'true' && steps.create.outputs.jira_key != ''
        uses: actions/github-script@v7
        env:
          JIRA_KEY: ${{ steps.create.outputs.jira_key }}
          JIRA_BASE: ${{ secrets.JIRA_BASE_URL }}
          LABEL: ${{ inputs.github_linked_label }}
        with:
          script: |
            const { JIRA_KEY, JIRA_BASE, LABEL } = process.env;
            const issue = context.payload.issue;

            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              title: `[${JIRA_KEY}] ${issue.title}`
            });

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: `‚úÖ Jira Ìã∞Ïºì ÏÉùÏÑ±Îê®: [${JIRA_KEY}](${JIRA_BASE}/browse/${JIRA_KEY})`
            });

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              labels: [LABEL]
            });

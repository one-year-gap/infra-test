name: jira-sync-from-gh-issue

on:
  workflow_call:
    inputs:
      jira_project_key:
        type: string
        required: true
      jira_start_date_field:
        type: string
        required: false
        default: "customfield_10015" # Jira ì‹œì‘ ë‚ ì§œ í•„ë“œ ID
    secrets:
      JIRA_BASE_URL:
        required: true
      JIRA_EMAIL:
        required: true
      JIRA_API_TOKEN:
        required: true

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: write

    steps:
      # 1. ì´ìŠˆ ë³¸ë¬¸ íŒŒì‹± (ìƒìœ„ í‹°ì¼“, ë‚ ì§œ, ë¼ë²¨ ë°ì´í„° ì¶”ì¶œ)
      - name: Parse Issue Body
        id: parse
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.issue.body || "";
            const extract = (id) => {
              const regex = new RegExp(`### ${id}\\s+([\\s\\S]*?)(?=\\n###|$)`);
              const match = body.match(regex);
              return match ? match[1].trim() : "";
            };

            core.setOutput('parentKey', extract('ğŸŸï¸ ìƒìœ„ ì‘ì—… \\(Ticket Number\\)'));
            core.setOutput('startDate', extract('ğŸ“… ì‹œì‘ ë‚ ì§œ'));
            core.setOutput('endDate', extract('ğŸ ì¢…ë£Œ ë‚ ì§œ'));
            core.setOutput('type', extract('Type \\(í•„ìˆ˜\\)'));
            core.setOutput('area', extract('Area \\(í•„ìˆ˜\\)'));
            core.setOutput('priority', extract('Priority \\(í•„ìˆ˜\\)'));

      # 2. ìë™ ë¼ë²¨ë§ (ReferenceError ìˆ˜ì •ë¨)
      - name: Auto-Labeling GitHub Issue
        if: github.event.action == 'opened' || github.event.action == 'reopened'
        uses: actions/github-script@v7
        env:
          ISSUE_TYPE: ${{ steps.parse.outputs.type }}
          ISSUE_AREA: ${{ steps.parse.outputs.area }}
          ISSUE_PRIO: ${{ steps.parse.outputs.priority }}
        with:
          script: |
            const { ISSUE_TYPE, ISSUE_AREA, ISSUE_PRIO } = process.env;
            const labelsToAdd = [ISSUE_TYPE, ISSUE_AREA, ISSUE_PRIO].filter(l => l && l !== 'ì„ íƒí•˜ì„¸ìš”');
            
            if (labelsToAdd.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.issue.number,
                labels: labelsToAdd
              });
            }

      # 3. Jira í‹°ì¼“ ìƒì„± (ìƒìœ„ í•­ëª© ì—°ê²° + íƒ€ì„ë¼ì¸ ë°˜ì˜)
      - name: Create Jira Issue
        id: create
        if: github.event.action == 'opened' || github.event.action == 'reopened'
        env:
          JIRA_EMAIL: ${{ secrets.JIRA_EMAIL }}
          JIRA_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          JIRA_BASE: ${{ secrets.JIRA_BASE_URL }}
          START_FIELD: ${{ inputs.jira_start_date_field }}
        run: |
          # Type ë§µí•‘
          case "${{ steps.parse.outputs.type }}" in
            "âœ¨ feat") JIRA_TYPE="ìŠ¤í† ë¦¬" ;;
            "ğŸ› fix" | "ğŸš‘ hotfix") JIRA_TYPE="ë²„ê·¸" ;;
            *) JIRA_TYPE="ì‘ì—…" ;;
          esac

          # Payload ìƒì„± (jqë¥¼ ì‚¬ìš©í•˜ì—¬ ì•ˆì „í•˜ê²Œ êµ¬ì„±)
          PAYLOAD=$(jq -n \
            --arg proj "${{ inputs.jira_project_key }}" \
            --arg type "$JIRA_TYPE" \
            --arg sum "${{ github.event.issue.title }}" \
            --arg desc "GitHub: ${{ github.event.issue.html_url }}\n\n${{ github.event.issue.body }}" \
            --arg parent "${{ steps.parse.outputs.parentKey }}" \
            --arg start "${{ steps.parse.outputs.startDate }}" \
            --arg end "${{ steps.parse.outputs.endDate }}" \
            --arg sf "$START_FIELD" \
            '{
              fields: {
                project: { key: $proj },
                issuetype: { name: $type },
                summary: $sum,
                description: { type: "doc", version: 1, content: [{ type: "paragraph", content: [{ type: "text", text: $desc }] }] },
                parent: (if $parent != "" then { key: $parent } else null end),
                duedate: (if $end != "" then $end else null end),
                ($sf): (if $start != "" then $start else null end)
              }
            }' | jq 'del(.fields.parent | select(. == null))')

          RES=$(curl -s -u "$JIRA_EMAIL:$JIRA_TOKEN" -X POST -H "Content-Type: application/json" -d "$PAYLOAD" "$JIRA_BASE/rest/api/3/issue")
          
          KEY=$(echo $RES | jq -r '.key // empty')
          if [ -z "$KEY" ]; then
            echo "Jira Issue Creation Failed: $RES"
            exit 1
          fi
          echo "jira_key=$KEY" >> "$GITHUB_OUTPUT"

      # 4. ìƒíƒœ ë³€ê²½: 'ì§„í–‰ ì¤‘' (Transition ID 21)
      - name: Transition to In Progress
        if: steps.create.outputs.jira_key != ''
        env:
          JIRA_EMAIL: ${{ secrets.JIRA_EMAIL }}
          JIRA_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          JIRA_BASE: ${{ secrets.JIRA_BASE_URL }}
        run: |
          curl -s -u "$JIRA_EMAIL:$JIRA_TOKEN" -X POST -H "Content-Type: application/json" \
            -d '{"transition": {"id": "21"}}' \
            "$JIRA_BASE/rest/api/3/issue/${{ steps.create.outputs.jira_key }}/transitions"

      # 5. ì´ìŠˆ Close ì‹œ Jira 'ì™„ë£Œ' (Transition ID 31)
      - name: Transition to Done
        if: github.event.action == 'closed'
        env:
          JIRA_EMAIL: ${{ secrets.JIRA_EMAIL }}
          JIRA_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          JIRA_BASE: ${{ secrets.JIRA_BASE_URL }}
        run: |
          KEY=$(echo "${{ github.event.issue.title }}" | grep -oE '[A-Z0-9]+-[0-9]+' | head -1)
          if [ -n "$KEY" ]; then
            curl -s -u "$JIRA_EMAIL:$JIRA_TOKEN" -X POST -H "Content-Type: application/json" \
              -d '{"transition": {"id": "31"}}' \
              "$JIRA_BASE/rest/api/3/issue/$KEY/transitions"
          fi

      # 6. GitHub ì´ìŠˆ ìµœì¢… ì—…ë°ì´íŠ¸ (ì œëª© ë³€ê²½ ë° ì½”ë©˜íŠ¸)
      - name: Finalize GitHub Issue
        if: steps.create.outputs.jira_key != ''
        uses: actions/github-script@v7
        env:
          JIRA_KEY: ${{ steps.create.outputs.jira_key }}
          JIRA_BASE: ${{ secrets.JIRA_BASE_URL }}
        with:
          script: |
            const { JIRA_KEY, JIRA_BASE } = process.env;
            const issue = context.payload.issue;
            
            // ì œëª©ì— ì§€ë¼ í‚¤ ì‚½ì…
            const cleanTitle = issue.title.replace(/^\[[A-Z0-9-]+\]\s+/, "").trim();
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              title: `[${JIRA_KEY}] ${cleanTitle}`
            });

            // ì—°ë™ ê²°ê³¼ ì•Œë¦¼ ì½”ë©˜íŠ¸
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: `### âœ… Jira ì—°ë™ ì„±ê³µ\n- **í‹°ì¼“:** [${JIRA_KEY}](${JIRA_BASE}/browse/${JIRA_KEY})\n- **ìƒíƒœ:** ì§„í–‰ ì¤‘ (In Progress)\n- **ìƒìœ„ í•­ëª©:** \`${{ steps.parse.outputs.parentKey }}\`\n- **ê¸°ê°„:** ${{ steps.parse.outputs.startDate }} ~ ${{ steps.parse.outputs.endDate }}`
            });

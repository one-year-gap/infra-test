name: jira-sync-on-pr

on:
  workflow_call:
    secrets:
      JIRA_BASE_URL:
        required: true
      JIRA_EMAIL:
        required: true
      JIRA_API_TOKEN:
        required: true

      SLACK_WEBHOOK_BE:
        required: false
      SLACK_WEBHOOK_FE:
        required: false
      SLACK_WEBHOOK_INFRA:
        required: false
      SLACK_WEBHOOK_DEFAULT:
        required: false

jobs:
  pr-sync:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: write
      contents: read

    steps:
      # 1) PR Î≥∏Î¨∏ÏóêÏÑú Îç∞Ïù¥ÌÑ∞ Ï∂îÏ∂ú
      - name: Extract Metadata
        id: meta
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.pull_request.body || "";
            const jiraKey = body.match(/[A-Z][A-Z0-9]+-[0-9]+/)?.[0];
            const issueNumber = body.match(/closes\s+#(\d+)/i)?.[1];

            core.setOutput('jira_key', jiraKey || '');
            core.setOutput('issue_number', issueNumber || '');

      - name: Sync Labels from Issue
        id: sync_labels
        if: github.event.action == 'opened' && steps.meta.outputs.issue_number != ''
        uses: actions/github-script@v7
        with:
          script: |
            const issue_number = parseInt("${{ steps.meta.outputs.issue_number }}", 10);

            const issue = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number
            });

            const labels = issue.data.labels.map(l => typeof l === 'string' ? l : l.name);

            const typeLabel = labels.find(l =>
              l.startsWith('‚ú®') || l.startsWith('üêõ') || l.startsWith('üöë') ||
              l.startsWith('‚ôªÔ∏è') || l.startsWith('üé®') || l.startsWith('‚úÖ') ||
              l.startsWith('üìï') || l.startsWith('üßπ') || l.startsWith('üîß') ||
              l.startsWith('üì¶') || l.startsWith('üèóÔ∏è') || l.startsWith('üöÄ') ||
              l.startsWith('üè∑Ô∏è') || l.startsWith('üõ°Ô∏è') || l.startsWith('‚ö°') ||
              l.startsWith('üß™') || l.startsWith('üîÑ') || l.startsWith('üóëÔ∏è') ||
              l.startsWith('üîñ')
            );

            const areaLabel = labels.find(l =>
              l.includes('BE') || l.includes('FE') || l.includes('INFRA')
            );

            const priorityLabel = labels.find(l =>
              l.startsWith('P0') || l.startsWith('P1') || l.startsWith('P2')
            );

            core.setOutput('type_label', typeLabel || '');
            core.setOutput('area_label', areaLabel || '');
            core.setOutput('priority_label', priorityLabel || '');

            if (labels.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                labels
              });
            }

      # 2) PR Ï†úÎ™©Ïóê [Ìã∞ÏºìÎ≤àÌò∏] <type>: ÏûêÎèô Ï∂îÍ∞Ä
      - name: Update PR Title
        if: github.event.action == 'opened' && steps.meta.outputs.jira_key != ''
        uses: actions/github-script@v7
        env:
          JIRA_KEY: ${{ steps.meta.outputs.jira_key }}
          TYPE_LABEL: ${{ steps.sync_labels.outputs.type_label }}
        with:
          script: |
            const { JIRA_KEY, TYPE_LABEL } = process.env;
            const pr = context.payload.pull_request;

            const typeMap = {
              "‚ú® feat": "feat",
              "üêõ fix": "fix",
              "üöë hotfix": "hotfix",
              "‚ôªÔ∏è refactor": "refactor",
              "üé® style": "style",
              "‚úÖ test": "test",
              "üìï docs": "docs",
              "üßπ chore": "chore",
              "üîß config": "config",
              "üì¶ deps": "deps",
              "üèóÔ∏è build": "build",
              "üöÄ deploy": "deploy",
              "üè∑Ô∏è release": "release",
              "üõ°Ô∏è security": "security",
              "‚ö° perf": "perf",
              "üß™ spike": "spike",
              "üîÑ rename": "rename",
              "üóëÔ∏è remove": "remove",
              "üîñ init": "init"
            };

            const commitType = typeMap[TYPE_LABEL] || "task";

            const cleanTitle = pr.title
              .replace(/^\[[A-Z0-9-]+\]\s*/, "")
              .replace(/^(feat|fix|hotfix|refactor|style|test|docs|chore|config|deps|build|deploy|release|security|perf|spike|rename|remove|init|task):\s*/i, "")
              .trim();

            const newTitle = `[${JIRA_KEY}] ${commitType}: ${cleanTitle}`;

            await github.rest.pulls.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number,
              title: newTitle
            });

      # 3) Slack Alarm
      - name: Notify Slack (All Channels)
        if: github.event.action == 'opened'
        env:
          AREA_LABEL: ${{ steps.sync_labels.outputs.area_label }}
          TYPE_LABEL: ${{ steps.sync_labels.outputs.type_label }}
          PRIORITY_LABEL: ${{ steps.sync_labels.outputs.priority_label }}
          JIRA_KEY: ${{ steps.meta.outputs.jira_key }}
          SLACK_WEBHOOK_BE: ${{ secrets.SLACK_WEBHOOK_BE }}
          SLACK_WEBHOOK_FE: ${{ secrets.SLACK_WEBHOOK_FE }}
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          SLACK_WEBHOOK_INFRA: ${{ secrets.SLACK_WEBHOOK_INFRA }}
          SLACK_WEBHOOK_DEFAULT: ${{ secrets.SLACK_WEBHOOK_DEFAULT }}
        run: |
          set -euo pipefail

          PR_URL="${{ github.event.pull_request.html_url }}"
          PR_TITLE="${{ github.event.pull_request.title }}"
          REPO="${{ github.repository }}"
          AUTHOR="${{ github.event.pull_request.user.login }}"
          JIRA_DOMAIN="${JIRA_BASE_URL}"


          COLOR="#36a64f"  
          if [[ "${PRIORITY_LABEL:-}" == *"P0"* ]] || [[ "${PRIORITY_LABEL:-}" == *"p0"* ]]; then
            COLOR="#ff0000"  
          elif [[ "${PRIORITY_LABEL:-}" == *"P1"* ]] || [[ "${PRIORITY_LABEL:-}" == *"p1"* ]]; then
            COLOR="#ff9500"  
          elif [[ "${PRIORITY_LABEL:-}" == *"P2"* ]] || [[ "${PRIORITY_LABEL:-}" == *"p2"* ]]; then
            COLOR="#ffcc00"
          fi


          TYPE_EMOJI="üìù"
          if [[ "${TYPE_LABEL:-}" == *"feat"* ]]; then
            TYPE_EMOJI="‚ú®"
          elif [[ "${TYPE_LABEL:-}" == *"fix"* ]]; then
            TYPE_EMOJI="üêõ"
          elif [[ "${TYPE_LABEL:-}" == *"hotfix"* ]]; then
            TYPE_EMOJI="üöë"
          elif [[ "${TYPE_LABEL:-}" == *"refactor"* ]]; then
            TYPE_EMOJI="‚ôªÔ∏è"
          elif [[ "${TYPE_LABEL:-}" == *"style"* ]]; then
            TYPE_EMOJI="üé®"
          elif [[ "${TYPE_LABEL:-}" == *"test"* ]]; then
            TYPE_EMOJI="‚úÖ"
          elif [[ "${TYPE_LABEL:-}" == *"docs"* ]]; then
            TYPE_EMOJI="üìï"
          elif [[ "${TYPE_LABEL:-}" == *"chore"* ]]; then
            TYPE_EMOJI="üßπ"
          fi

   
          AREA_EMOJI="üíº"
          if [[ "${AREA_LABEL:-}" == *"BE"* ]]; then
            AREA_EMOJI="‚öôÔ∏è"
          elif [[ "${AREA_LABEL:-}" == *"FE"* ]]; then
            AREA_EMOJI="üé®"
          elif [[ "${AREA_LABEL:-}" == *"INFRA"* ]]; then
            AREA_EMOJI="üèóÔ∏è"
          fi


          JIRA_LINK="N/A"
          if [ -n "${JIRA_KEY:-}" ] && [ -n "${JIRA_BASE_URL:-}" ]; then
            JIRA_LINK="<${JIRA_BASE_URL}/browse/${JIRA_KEY}|${JIRA_KEY}>"
          fi
          
          PAYLOAD=$(jq -n \
            --arg color "$COLOR" \
            --arg pr_url "$PR_URL" \
            --arg pr_title "$PR_TITLE" \
            --arg author "$AUTHOR" \
            --arg repo "$REPO" \
            --arg type_emoji "$TYPE_EMOJI" \
            --arg type_label "${TYPE_LABEL:-N/A}" \
            --arg area_emoji "$AREA_EMOJI" \
            --arg area_label "${AREA_LABEL:-N/A}" \
            --arg priority "${PRIORITY_LABEL:-N/A}" \
            --arg jira "$JIRA_LINK" \
            '{
              attachments: [
                {
                  color: $color,
                  blocks: [
                    {
                      type: "header",
                      text: {
                        type: "plain_text",
                        text: "üöÄ New Pull Request Opened!",
                        emoji: true
                      }
                    },
                    {
                      type: "section",
                      text: {
                        type: "mrkdwn",
                        text: ("*<" + $pr_url + "|" + $pr_title + ">*")
                      }
                    },
                    {
                      type: "divider"
                    },
                    {
                      type: "section",
                      fields: [
                        {
                          type: "mrkdwn",
                          text: ("üë§ *Author*\n" + $author)
                        },
                        {
                          type: "mrkdwn",
                          text: ("üì¶ *Repository*\n`" + $repo + "`")
                        }
                      ]
                    },
                    {
                      type: "section",
                      fields: [
                        {
                          type: "mrkdwn",
                          text: ($type_emoji + " *Type*\n`" + $type_label + "`")
                        },
                        {
                          type: "mrkdwn",
                          text: ($area_emoji + " *Area*\n`" + $area_label + "`")
                        }
                      ]
                    },
                    {
                      type: "section",
                      fields: [
                        {
                          type: "mrkdwn",
                          text: ("‚ö° *Priority*\n`" + $priority + "`")
                        },
                        {
                          type: "mrkdwn",
                          text: ("üé´ *JIRA*\n" + $jira)
                        }
                      ]
                    },
                    {
                      type: "divider"
                    },
                    {
                      type: "actions",
                      elements: [
                        {
                          type: "button",
                          text: {
                            type: "plain_text",
                            text: "üëÄ View PR",
                            emoji: true
                          },
                          url: $pr_url,
                          style: "primary"
                        }
                      ]
                    }
                  ]
                }
              ]
            }')



          declare -a TARGETS=()

          if [ -n "${SLACK_WEBHOOK_DEFAULT:-}" ]; then
            TARGETS+=("${SLACK_WEBHOOK_DEFAULT}")
          fi

          if [[ "${AREA_LABEL:-}" == *"BE"* ]] && [ -n "${SLACK_WEBHOOK_BE:-}" ]; then
            TARGETS+=("${SLACK_WEBHOOK_BE}")
          elif [[ "${AREA_LABEL:-}" == *"FE"* ]] && [ -n "${SLACK_WEBHOOK_FE:-}" ]; then
            TARGETS+=("${SLACK_WEBHOOK_FE}")
          elif [[ "${AREA_LABEL:-}" == *"INFRA"* ]] && [ -n "${SLACK_WEBHOOK_INFRA:-}" ]; then
            TARGETS+=("${SLACK_WEBHOOK_INFRA}")
          fi

        
          if [ ${#TARGETS[@]} -eq 0 ]; then
            for w in "${SLACK_WEBHOOK_BE:-}" "${SLACK_WEBHOOK_FE:-}" "${SLACK_WEBHOOK_INFRA:-}"; do
              if [ -n "$w" ]; then TARGETS+=("$w"); break; fi
            done
          fi

          if [ ${#TARGETS[@]} -eq 0 ]; then
            echo "No Slack webhooks configured. Skipping notification."
            exit 0
          fi

        
          uniq_targets=$(printf "%s\n" "${TARGETS[@]}" | awk '!seen[$0]++')
          echo "$uniq_targets" | while read -r hook; do
            echo "sending"
            curl -sS -X POST -H 'Content-type: application/json' --data "$PAYLOAD" "$hook"
          done

          echo "Slack notifications sent successfully!"

      - name: Transition Jira to Done
        if: github.event.pull_request.merged == true && steps.meta.outputs.jira_key != ''
        env:
          JIRA_EMAIL: ${{ secrets.JIRA_EMAIL }}
          JIRA_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          JIRA_BASE: ${{ secrets.JIRA_BASE_URL }}
          JIRA_KEY: ${{ steps.meta.outputs.jira_key }}
        run: |
          curl -s -u "$JIRA_EMAIL:$JIRA_TOKEN" -X POST -H "Content-Type: application/json" \
            -d '{"transition": {"id": "31"}}' \
            "$JIRA_BASE/rest/api/3/issue/$JIRA_KEY/transitions"

name: jira-sync-on-pr
on:
  workflow_call:
    secrets:
      JIRA_BASE_URL: { required: true }
      JIRA_EMAIL: { required: true }
      JIRA_API_TOKEN: { required: true }
jobs:
  pr-sync:
    runs-on: ubuntu-latest
    permissions:
      issues: read
      pull-requests: write
      contents: read
    steps:
      # 1. PR ë³¸ë¬¸ì—ì„œ ë°ì´í„° ì¶”ì¶œ
      - name: Extract Metadata
        id: meta
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.pull_request.body || ""; 
            const jiraKey = body.match(/[A-Z][A-Z0-9]+-[0-9]+/)?.[0];
            const issueNumber = body.match(/closes\s+#(\d+)/i)?.[1];
            core.setOutput('jira_key', jiraKey || '');
            core.setOutput('issue_number', issueNumber || '');
     
      - name: Sync Labels from Issue
        id: sync_labels
        if: github.event.action == 'opened' && steps.meta.outputs.issue_number != ''
        uses: actions/github-script@v7
        with:
          script: |
            const issue_number = parseInt("${{ steps.meta.outputs.issue_number }}");
            
            const issue = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue_number
            });
            
            const labels = issue.data.labels.map(l => typeof l === 'string' ? l : l.name);
            
            const typeLabel = labels.find(l => 
              l.startsWith('âœ¨') || l.startsWith('ğŸ›') || l.startsWith('ğŸš‘') || 
              l.startsWith('â™»ï¸') || l.startsWith('ğŸ¨') || l.startsWith('âœ…') ||
              l.startsWith('ğŸ“•') || l.startsWith('ğŸ§¹') || l.startsWith('ğŸ”§') ||
              l.startsWith('ğŸ“¦') || l.startsWith('ğŸ—ï¸') || l.startsWith('ğŸš€') ||
              l.startsWith('ğŸ·ï¸') || l.startsWith('ğŸ›¡ï¸') || l.startsWith('âš¡') ||
              l.startsWith('ğŸ§ª') || l.startsWith('ğŸ”„') || l.startsWith('ğŸ—‘ï¸') ||
              l.startsWith('ğŸ”–')
            );
            
            core.setOutput('type_label', typeLabel || '');
            
            if (labels.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                labels: labels
              });
            }

      # 2. PR ì œëª©ì— [í‹°ì¼“ë²ˆí˜¸] <type>: ìë™ ì¶”ê°€
      - name: Update PR Title
        if: github.event.action == 'opened' && steps.meta.outputs.jira_key != ''
        uses: actions/github-script@v7
        env:
          JIRA_KEY: ${{ steps.meta.outputs.jira_key }}
          TYPE_LABEL: ${{ steps.sync_labels.outputs.type_label }}
        with:
          script: |
            const { JIRA_KEY, TYPE_LABEL } = process.env;
            const pr = context.payload.pull_request;
            
            const typeMap = {
              "âœ¨ feat": "feat",
              "ğŸ› fix": "fix",
              "ğŸš‘ hotfix": "hotfix",
              "â™»ï¸ refactor": "refactor",
              "ğŸ¨ style": "style",
              "âœ… test": "test",
              "ğŸ“• docs": "docs",
              "ğŸ§¹ chore": "chore",
              "ğŸ”§ config": "config",
              "ğŸ“¦ deps": "deps",
              "ğŸ—ï¸ build": "build",
              "ğŸš€ deploy": "deploy",
              "ğŸ·ï¸ release": "release",
              "ğŸ›¡ï¸ security": "security",
              "âš¡ perf": "perf",
              "ğŸ§ª spike": "spike",
              "ğŸ”„ rename": "rename",
              "ğŸ—‘ï¸ remove": "remove",
              "ğŸ”– init": "init"
            };
            
            const commitType = typeMap[TYPE_LABEL] || "task";
            
            let cleanTitle = pr.title
              .replace(/^\[[A-Z0-9-]+\]\s*/, "")
              .replace(/^(feat|fix|hotfix|refactor|style|test|docs|chore|config|deps|build|deploy|release|security|perf|spike|rename|remove|init|task):\s*/i, "")
              .trim();
            
        
            const newTitle = `[${JIRA_KEY}] ${commitType}: ${cleanTitle}`;
            
            await github.rest.pulls.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number,
              title: newTitle
            });

      - name: Transition Jira to Done
        if: github.event.pull_request.merged == true && steps.meta.outputs.jira_key != ''
        env:
          JIRA_EMAIL: ${{ secrets.JIRA_EMAIL }}
          JIRA_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          JIRA_BASE: ${{ secrets.JIRA_BASE_URL }}
          JIRA_KEY: ${{ steps.meta.outputs.jira_key }}
        run: |
          curl -s -u "$JIRA_EMAIL:$JIRA_TOKEN" -X POST -H "Content-Type: application/json" \
            -d '{"transition": {"id": "31"}}' \
            "$JIRA_BASE/rest/api/3/issue/$JIRA_KEY/transitions"

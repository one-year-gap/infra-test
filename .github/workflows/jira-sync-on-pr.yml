name: jira-sync-on-pr

on:
  workflow_call:
    secrets:
      JIRA_BASE_URL: { required: true }
      JIRA_EMAIL: { required: true }
      JIRA_API_TOKEN: { required: true }

jobs:
  pr-sync:
    runs-on: ubuntu-latest
    permissions:
      issues: read
      pull-requests: write
      contents: read

    steps:
      # 1. PR 본문에서 데이터 추출 (Jira Key, Issue Number)
      - name: Extract Metadata
        id: meta
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.pull_request.body || ""; 
            const jiraKey = body.match(/[A-Z][A-Z0-9]+-[0-9]+/)?.[0];
            const issueNumber = body.match(/closes\s+#(\d+)/i)?.[1];

            core.setOutput('jira_key', jiraKey || '');
            core.setOutput('issue_number', issueNumber || '');

     
      - name: Sync Labels from Issue
        if: github.event.action == 'opened' && steps.meta.outputs.issue_number != ''
        uses: actions/github-script@v7
        with:
          script: |
            const issue_number = parseInt("${{ steps.meta.outputs.issue_number }}");
            
      
            const issue = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue_number
            });
            
            const labels = issue.data.labels.map(l => typeof l === 'string' ? l : l.name);
            
  
            if (labels.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                labels: labels
              });
            }

      - name: Transition Jira to Done
        if: github.event.pull_request.merged == true && steps.meta.outputs.jira_key != ''
        env:
          JIRA_EMAIL: ${{ secrets.JIRA_EMAIL }}
          JIRA_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          JIRA_BASE: ${{ secrets.JIRA_BASE_URL }}
          JIRA_KEY: ${{ steps.meta.outputs.jira_key }}
        run: |
          # '완료' 트랜지션 ID (보통 31 또는 41 - 확인 필요)
          curl -s -u "$JIRA_EMAIL:$JIRA_TOKEN" -X POST -H "Content-Type: application/json" \
            -d '{"transition": {"id": "31"}}' \
            "$JIRA_BASE/rest/api/3/issue/$JIRA_KEY/transitions"
